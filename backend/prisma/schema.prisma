// Prisma Schema for Rent-a-Car Application
// Using PostgreSQL with hybrid JSONB approach for franchise applications

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Transmission {
  MANUAL
  AUTO
}

enum FuelType {
  PETROL
  DIESEL
  ELECTRIC
  HYBRID
  LPG
}

enum CarCategory {
  ECONOMY
  COMPACT
  MIDSIZE
  FULLSIZE
  SUV
  VAN
  LUXURY
}

enum CarStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

enum UserRole {
  ADMIN
  STAFF
  USER
}

enum BookingStatus {
  RESERVED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

enum FranchiseApplicationStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  APPROVED
  REJECTED
}

// ============================================================================
// MODELS
// ============================================================================

/// Branch represents a rental location/office
model Branch {
  id       String  @id @default(uuid())
  name     String
  address  String
  city     String
  phone    String?
  isActive Boolean @default(true)

  // Relations
  cars            Car[]
  pickupBookings  Booking[] @relation("PickupBranch")
  dropoffBookings Booking[] @relation("DropoffBranch")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city])
  @@index([isActive])
}

enum CarType {
  RENTAL
  SALE
}

/// Car represents a vehicle available for rental or sale
model Car {
  id                  String       @id @default(uuid())
  brand               String
  brandLogo           String? // Custom brand logo URL
  model               String
  year                Int
  type                CarType      @default(RENTAL) // Default to rental
  transmission        Transmission
  fuel                FuelType
  category            CarCategory
  seats               Int
  doors               Int
  color               String
  plateNumber         String       @unique
  dailyPrice          Decimal?     @db.Decimal(10, 2) // Optional for SALE cars
  weeklyPrice         Decimal?     @db.Decimal(10, 2)
  salePrice           Decimal?     @db.Decimal(12, 2) // Price for SALE cars
  deposit             Decimal?     @db.Decimal(10, 2)
  mileage             Int
  images              String[] // Array of image URLs
  status              CarStatus    @default(ACTIVE)
  isFeatured          Boolean      @default(false)
  accidentDescription String? // Tramer/Hasar Kaydı Info
  changedParts        String[] // List of changed parts
  paintedParts        String[] // List of painted parts
  features            String[] // Extra features (Sunroof, Nav, etc.)
  description         String?

  // Relations
  branch   Branch    @relation(fields: [branchId], references: [id])
  branchId String
  bookings Booking[]

  version   Int      @default(0) // Optimistic locking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brand])
  @@index([category])
  @@index([status])
  @@index([branchId])
  @@index([dailyPrice])
  @@index([salePrice])
  @@index([type])
  @@index([isFeatured])
}

/// User represents a system user (customer or admin)
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  phone        String?
  role         UserRole @default(USER)

  // Relations
  bookings              Booking[]
  franchiseApplications FranchiseApplication[]
  insurances            UserInsurance[]
  actionLogs            ActionLog[]

  whatsappEnabled Boolean @default(true)

  version   Int      @default(0) // Optimistic locking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
}

/// Booking represents a car rental reservation
model Booking {
  id          String @id @default(uuid())
  bookingCode String @unique // Human-readable code like RNT-ABC123

  // Car relation
  car   Car    @relation(fields: [carId], references: [id])
  carId String

  // User relation (optional - for admin tracking only)
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  // Customer info (always required - no login needed)
  customerName          String
  customerSurname       String?
  customerPhone         String
  customerEmail         String?
  customerTC            String? // TC Kimlik No
  customerDriverLicense String? // Ehliyet No
  notes                 String? // Customer notes

  // Rental period
  pickupDate          DateTime
  dropoffDate         DateTime
  originalDropoffDate DateTime? // For tracking extensions

  // Branch relations
  pickupBranch    Branch @relation("PickupBranch", fields: [pickupBranchId], references: [id])
  pickupBranchId  String
  dropoffBranch   Branch @relation("DropoffBranch", fields: [dropoffBranchId], references: [id])
  dropoffBranchId String

  // Pricing
  totalPrice Decimal? @db.Decimal(10, 2)

  // Booking status
  status BookingStatus @default(RESERVED)

  // Admin notification status
  adminRead Boolean @default(false)

  // Payment fields (for future payment integration)
  paymentStatus   PaymentStatus @default(UNPAID)
  paymentProvider String?
  paymentRef      String?
  paidAt          DateTime?
  expiresAt       DateTime? // For 10-minute payment window

  version   Int      @default(0) // Optimistic locking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([bookingCode])
  @@index([carId, pickupDate, dropoffDate])
  @@index([carId, status])
  @@index([userId])
  @@index([status])
  @@index([customerPhone])
}

/// FranchiseApplication - Hybrid approach with normalized key fields + JSONB details
model FranchiseApplication {
  id     String                     @id @default(uuid())
  status FranchiseApplicationStatus @default(DRAFT)

  // Admin notification status
  adminRead Boolean @default(false)

  // Applicant relation (optional for public applications)
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  // Key searchable fields (normalized for indexing/filtering)
  companyName  String?
  contactName  String
  contactEmail String
  contactPhone String
  city         String?

  // Extensible detailed form data (JSONB)
  // Structure: { personalInfo, companyInfo, locationDetails, financials, 
  //              experience, staffPlan, fleetPlan, marketingPlan, 
  //              references, declarations, documentUrls }
  details Json @default("{}")

  // Admin workflow fields
  adminNotes  String?
  reviewedBy  String?
  reviewedAt  DateTime?
  submittedAt DateTime?

  // Audit trail
  auditLogs FranchiseAuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([userId])
  @@index([city])
  @@index([submittedAt])
}

/// FranchiseAuditLog tracks all changes to franchise applications
model FranchiseAuditLog {
  id String @id @default(uuid())

  application   FranchiseApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  applicationId String

  action        String // e.g., "CREATED", "UPDATED", "STATUS_CHANGE", "SUBMITTED"
  previousValue Json? // Previous state (for field changes)
  newValue      Json? // New state (for field changes)
  performedBy   String // User ID who performed the action
  note          String? // Optional note/comment

  createdAt DateTime @default(now())

  @@index([applicationId])
  @@index([createdAt])
}

/// Campaign represents a homepage banner
model Campaign {
  id                String  @id @default(uuid())
  title             String
  description       String
  imageUrl          String?
  ctaText           String?
  ctaLink           String?
  tag               String? // e.g. "YENİ HİZMET"
  requiredCondition String? // e.g. "HAS_SALE_CARS"
  isActive          Boolean @default(true)
  order             Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([order])
}

/// UserInsurance represents insurance coverage details for a user
model UserInsurance {
  id String @id @default(uuid())

  user   User   @relation(fields: [userId], references: [id])
  userId String

  companyName  String
  policyNumber String   @unique
  policyType   String? // e.g. "Trafik", "Kasko", "Ferdi Kaza"
  startDate    DateTime
  endDate      DateTime

  // Financial Details
  premiumAmount    Decimal? @db.Decimal(10, 2)
  coverageLimit    Decimal? @db.Decimal(12, 2)
  deductibleAmount Decimal? @db.Decimal(10, 2)

  coverageType String? // Keep for backward compatibility or general type
  description  String? // Detailed description of coverage

  // Agent/Contact Info
  agentName  String?
  agentPhone String?
  agentEmail String?

  documentUrl String?
  isActive    Boolean @default(true)

  // Status and Dates
  renewalDate   DateTime?
  paymentStatus String    @default("PAID") // PAID, UNPAID, CANCELLED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Admin notification status
  adminRead Boolean  @default(false)

  @@index([userId])
  @@index([policyNumber])
}

/// ActionLog tracks important actions performed by admins
model ActionLog {
  id String @id @default(uuid())

  user   User   @relation(fields: [userId], references: [id])
  userId String

  action    String // e.g., "LOGIN", "CREATE_CAR", "UPDATE_BOOKING"
  details   String? // JSON string or description of what changed
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
